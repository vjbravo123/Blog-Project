// // File: middleware.ts

// import { NextResponse } from 'next/server';
// import type { NextRequest } from 'next/server';
// import {
//   loginRateLimiter,
//   adminApiRateLimiter,
//   uploadRateLimiter,
//   generalApiRateLimiter,
//   getIP,
//   checkRateLimit,
//   getRateLimitHeaders,
// } from './lib/rate-limit';

// export default async function proxy(request: NextRequest) {
//   const { pathname } = request.nextUrl;
//   const ip = getIP(request);

//   // 1. Prepare Response & Security Headers
//   const response = NextResponse.next();

//   // Security Headers
//   response.headers.set('X-Content-Type-Options', 'nosniff');
//   response.headers.set('X-Frame-Options', 'DENY');
//   response.headers.set('X-XSS-Protection', '1; mode=block');
//   response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');

//   // HSTS (only in production)
//   if (process.env.NODE_ENV === 'production') {
//     response.headers.set(
//       'Strict-Transport-Security', 
//       'max-age=31536000; includeSubDomains'
//     );
//   }

//   // Content Security Policy (CSP)
//   // Updated: Allow images from any S3 bucket (*.amazonaws.com) and Data URIs (for base64)
//   const cspHeader = `
//     default-src 'self';
//     script-src 'self' 'unsafe-eval' 'unsafe-inline' https://vercel.live;
//     style-src 'self' 'unsafe-inline';
//     img-src 'self' blob: data: https://*.amazonaws.com; 
//     font-src 'self' data:;
//     connect-src 'self' https://*.upstash.io; 
//     frame-ancestors 'none';
//     base-uri 'self';
//     form-action 'self';
//   `.replace(/\s{2,}/g, ' ').trim();

//   response.headers.set('Content-Security-Policy', cspHeader);

//   // 2. Rate Limiting Logic
//   let rateLimitResult: { success: boolean; limit?: number; remaining?: number; reset?: number } = { success: true };

//   // A. Admin Login - Strict protection
//   if (pathname === '/api/auth/login' && request.method === 'POST') {
//     rateLimitResult = await checkRateLimit(loginRateLimiter, `login:${ip}`);
//   }
  
//   // B. Image Uploads - Moderate protection (prevent S3 spam)
//   // Adjust pathname if your upload route is different (e.g., /api/admin/upload)
//   else if (pathname.includes('/api/upload') && request.method === 'POST') {
//     rateLimitResult = await checkRateLimit(uploadRateLimiter, `upload:${ip}`);
//   }
  
//   // C. Admin Dashboard & Actions - Moderate protection
//   else if (pathname.startsWith('/api/dashboard') || pathname.startsWith('/api/admin')) {
//     rateLimitResult = await checkRateLimit(adminApiRateLimiter, `admin:${ip}`);
//   }
  
//   // D. General API (e.g., Viewing posts, Likes) - High limit to allow traffic
//   else if (pathname.startsWith('/api/')) {
//     rateLimitResult = await checkRateLimit(generalApiRateLimiter, `api:${ip}`);
//   }

//   // 3. Apply Rate Limit Headers
//   if (rateLimitResult.limit !== undefined) {
//     const rateLimitHeaders = getRateLimitHeaders(rateLimitResult);
//     Object.entries(rateLimitHeaders).forEach(([key, value]) => {
//       response.headers.set(key, value);
//     });
//   }

//   // 4. Handle Rate Limit Exceeded
//   if (!rateLimitResult.success) {
//     const retryAfter = rateLimitResult.reset
//       ? Math.ceil((rateLimitResult.reset - Date.now()) / 1000)
//       : 60;

//     return new NextResponse(
//       JSON.stringify({
//         success: false,
//         message: 'Too many requests. Please try again later.',
//         retryAfter,
//       }),
//       {
//         status: 429,
//         headers: {
//           'Content-Type': 'application/json',
//           'Retry-After': retryAfter.toString(),
//           ...getRateLimitHeaders(rateLimitResult),
//         },
//       }
//     );
//   }

//   return response;
// }

// export const config = {
//   matcher: [
//     /*
//      * Match all request paths except for:
//      * - _next/static (static files)
//      * - _next/image (image optimization)
//      * - favicon.ico (favicon file)
//      * - public folder
//      */
//     '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
//   ],
// };